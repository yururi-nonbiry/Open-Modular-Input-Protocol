# プロジェクトタスク一覧

## 完了済みタスク

### 1. プロジェクト基盤構築
- [x] `README.md`に基本仕様と技術選定を定義
- [x] `README.md`にProtobufスキーマやディレクトリ構造などの詳細仕様を追記
- [x] `proto`, `firmware`, `pc_software`, `docs`のディレクトリ構造を作成
- [x] `proto/omip.proto` プロトコル定義ファイルを作成

### 2. PCソフトウェア (バックエンド)
- [x] Pythonの仮想環境 (`pc_software/venv`) をセットアップ
- [x] `requirements.txt`を作成し、pyserial, protobuf, pynputを定義
- [x] Protobuf定義からPythonコード (`omip_pb2.py`) を生成
- [x] アーキテクチャをWebベースに変更
- [x] `requirements.txt`に`fastapi`, `uvicorn`, `python-socketio`などを追加し、インストール
- [x] `pc_software/main.py`をFastAPI + WebSocketサーバーとして再実装
- [x] サーバー起動時にシリアル通信をバックグラウンドで実行するよう設定

### 3. PCソフトウェア (フロントエンド)
- [x] `pc_software/ui`にVite + React + TypeScriptのプロジェクトを作成
- [x] フロントエンドプロジェクトの依存関係をインストール (`npm install`)
- [x] `Electron`および関連ライブラリ (`electron-builder`など) をインストール
- [x] Electronのメインプロセスファイル (`public/electron.js`) を作成
- [x] `package.json`を編集し、Electronの起動スクriptをセットアップ

## 残りのタスク

### 1. PCソフトウェア (フロントエンド)
- [x] **タスクトレイ常駐化**
    - [x] 起動時にウィンドウを開かず、タスクトレイにアイコンを表示する
    - [x] トレイアイコンの右クリックメニュー（設定、終了など）を実装する
    - [x] メニューから設定画面を開けるようにする
- [x] **UIの実装**
    - [x] バックエンドのWebSocketサーバーに接続するクライアントを実装する
    - [x] サーバーから受信したデバイスデータを画面に表示するコンポーネントを作成する
    - [x] 設定画面のUIを設計・実装する

### 2. ファームウェア (デバイス側)
- [x] `nanopb`を使い、`.proto`ファイルからC言語のヘッダ/ソースファイルを生成する
- [x] ESP32のサンプルファームウェアを作成する
    - [x] ボタンやアナログ入力の状態を読み取る
    - [x] 読み取ったデータをProtobufメッセージとしてシリアライズする
    - [x] 定義したフレーム形式でUSBシリアル経由でPCに送信する

### 3. 統合とパッケージ化
- [x] PythonバックエンドとElectronフロントエンドを一つのアプリケーションとして統合する仕組みを構築する
- [x] `electron-builder`を設定し、配布可能なインストーラー（.exeなど）を作成する

## 将来の拡張機能

### 1. Bluetooth LE対応
- [ ] **PCソフトウェア:**
  - [x] Bluetooth LEデバイスをスキャンし、接続候補としてUIに表示する機能を実装する。
  - [x] 選択したデバイスに接続し、データを受信する機能を実装する。
  - [ ] 接続方式（USB/BLE）に応じて、利用可能な機能をUI上で切り替える。
- [ ] **ファームウェア:**
  - [ ] ESP32ファームウェアに、Bluetooth LEサーバーとしての機能を追加する。
  - [ ] デバイス情報をアドバタイズし、PCからの接続を待機する。
  - [ ] 接続後は、ProtobufメッセージをGATT経由で送受信する。
- [ ] **機能制限の実装:**
  - [ ] Bluetooth LE接続時には、仕様書通りに画像転送などの高帯域幅機能を無効化するロジックをPCソフトウェアとファームウェアの両方に実装する。

### 2. M5Tab Stream Deck
- [x] **ファームウェア (M5Tab):**
  - [x] **画面の向きの変更:**
    - [x] 画面が縦方向で使われていたのを、横方向（右側が下面）になるように修正する。
  - [x] **UI描画:**
    - [x] 画面上部にボリュームと輝度調整用のUI（アイコン、スライダー等）を描画する。
    - [x] 3x6のアイコン用グリッドと、サイドバーのボリュームスライダーを描画する。
    - [x] PCから受信した`FEEDBACK_IMAGE`メッセージに基づき、各アイコンを描画する。
  - [x] **入力処理:**
    - [x] ヘッダーエリアのタッチを検出し、M5Tab本体のボリュームまたは輝度を調整する処理を実装する。
    - [x] タッチ入力を検出し、座標に応じてアイコンタップまたはスライダー操作を判定する。
    - [x] アイコンタップ時に、対応する`INPUT_DIGITAL`メッセージをPCに送信する。
    - [x] スライダー操作時に、`INPUT_ANALOG`メッセージ（正規化された値）をPCに送信する。
    - [x] 左右のスワイプを検出し、ページ切り替えイベントをPCに通知する（カスタムメッセージまたは`INPUT_ENCODER`等を流用）。
- [x] **PCソフトウェア:**
  - [x] **UI/設定:**
    - [x] M5Tabのページごとに3x6のショートカットを割り当てる設定画面を実装する。
    - [x] ボリュームスライダーに対応するOSの音量コントロール機能を実装する。
  - [x] **デバイス連携:**
    - [x] M5Tabからのページ切り替え通知を受け取り、表示するアイコンセットを`FEEDBACK_IMAGE`メッセージで更新する。
    - [x] アプリケーションのフォーカス変更を検知し、コンテキストに応じたアイコンセットを動的にM5Tabへ送信する。
    - [x] M5Tabからの`INPUT_ANALOG`入力をOSの音量に反映させる。

### 4. Joy-Con 左手デバイス化

- [ ] **基本接続と入力取得**
    - [x] Python環境に `hidapi` をセットアップする
    - [x] `pc_software/list_joycons.py` スクリプトを実行し、ペアリングしたJoy-Conが認識されるか確認する
    - [ ] PCに接続されたJoy-Conを検出し、接続を確立する
    - [ ] Joy-Conからボタン入力レポートを読み取り、コンソールに出力する
- [ ] **高度な機能の実装**
    - [ ] サブコマンドを送信してIMU（モーションセンサー）を有効化する
    - [ ] IMUデータを読み取り、解析する
    - [ ] HD振動を制御する機能を実装する
- [ ] **左手デバイスとしての機能実装**
    - [ ] `pynput` などのライブラリを導入する
    - [ ] ボタン入力やIMUデータに応じて、キーボード入力やマウス操作をエミュレートする
    - [ ] 設定ファイル（JSONなど）でキーマッピングをカスタマイズできる機能を実装する
- [ ] **UIとの連携**
    - [ ] 現在のPCソフトウェア（Electron + React）と連携し、設定画面をUI上に実装する
    - [ ] 接続状態やバッテリー残量をUIに表示する