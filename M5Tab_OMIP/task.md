# M5Tab Stream Deck 開発タスク

## 概要

`readme.md`の「10.1 M5Tab Stream Deck」仕様に基づき、M5Tabを多機能左手デバイスとして実装するためのタスクリスト。

---

## Milestone 1: 基本機能の実装

- [x] **仕様の定義と機能通知**
    - [x] `DeviceCapabilityResponse`で通知するポートを定義する。
        - メインエリア (3x6グリッド): `DIGITAL_INPUT` x 18個 (port_id: 0-17)
        - サイドバー (音量調整): `ANALOG_INPUT` x 1個 (port_id: 18)
        - ページ切り替え (左右スワイプ): `DIGITAL_INPUT` x 2個 (port_id: 19, 20)
        - LCD画面: `IMAGE_OUTPUT` x 1個 (screen_id: 0)
    - [x] PCから`DeviceCapabilityRequest`を受信したら、上記の仕様を詰めた`DeviceCapabilityResponse`を返信する処理を実装する。

- [x] **基本UIの描画**
    - [x] `setup()`で、画面に3x6のグリッド、ヘッダー、サイドバーの領域を線で描画する。

- [x] **タッチ入力の実装 (グリッド)**
    - [x] `loop()`内でタッチ座標を常に監視する。
    - [x] タッチされた座標が3x6のどのグリッドに対応するか判定する。
    - [x] グリッドがタッチされたら、対応する`port_id`を詰めた`InputDigital`メッセージを構築し、シリアル経由でPCに送信する。

- [x] **画像フィードバックの実装**
    - [x] PCから`FeedbackImage`メッセージを受信する処理を実装する。
    - [x] 受信した画像データをデコードし、メッセージで指定されたグリッド位置に描画する。

---

## Milestone 2: 応用機能の実装

- [x] **UI/UXの高度化**
    - [x] サイドバー領域の上下スライドを検知し、`ANALOG_INPUT`として音量情報を送信する処理を実装する。
    - [x] メインエリアの左右スワイプを検知し、ページ切り替え用の`InputDigital`メッセージを送信する処理を実装する。
    - [x] ヘッダー領域のタッチを検知し、デバイス設定（輝度調整など）のUIをオーバーレイ表示する機能を実装する。

- [x] **アイコン管理の効率化**
    - [x] PCから送られてくるアイコン画像をキャッシュし、ページ切り替え時の再描画を高速化する。

---

## 次のタスク：バグ修正

- [x] **アイコン転送の安定化（フロー制御の実装）**
    - **問題点:** PCからの高速なデータ送信にM5Tabのシリアル受信バッファが追いつかず、データ破損とクラッシュが発生している。
    - **対策:**
        - **M5Tab側 (`src/main.cpp`):**
            - `handle_feedback_image`関数内で、画像チャンクを1つ処理するごとに、PCへ準備完了の合図としてACK（`'A'`など）を1バイト送信する。
            - これまでのデバッグで追加した一時的なコード（ハートビートの`.`出力、`g_draw_test_rect`フラグ、テスト用の`fillRect`）をすべて削除する。
            - 描画処理を、`draw_jpeg_in_region`を呼び出す元のロジックに戻す。
        - **PC側 (`pc_software/send_icon.py`):**
            - チャンクを1つ送信するたびに、M5TabからACKが送られてくるのを待つ処理を追加する（タイムアウトも設定）。
            - デバッグ用に作成した一時ファイル（`create_test_image.py`, `test_icon.jpg`, `nanopb_pb2.py`）を削除する。

---

## 完了済みタスク

- `pb.h` が見つからないビルドエラーの修正
- プロジェクト仕様に基づいた`readme.md`の作成